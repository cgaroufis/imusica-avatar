<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Kinect &amp; HTML5</title>
        <link rel="stylesheet" type="text/css" href="bootstrap4/css/bootstrap.css" />
    </head>
    <body>
    <!-- Just an image -->
<nav class="navbar navbar-light bg-primary text-white">
  <a class="navbar-brand text-white" href="#">
    <!-- <img src="/assets/brand/bootstrap-solid.svg" width="30" height="30" alt=""> -->
    IMusica
  </a>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col-sm-12 col-md-9">
	  	<h5>3D Kinect Avatar and Gesture Recognition</h5>
		<div id="world" width="960" height="540"></div>
    </div>
    <div class="col-3">
      <div class="card" style="width: 18rem;">
	  <div class="card-body">
	    <h5 class="card-title">Details</h5>
			<h6> <label id="status">None</label> </h6>

<div class="form-group">
  <label for="mode">Select list:</label>
  <select class="form-control" id="mode">
	        <option value="1">Air Guitar</option>
	        <option value="2">Cello</option>
	        <option value="3">Double Instrument</option>
  </select>
</div>
        <button type="button" id="start-button"  class="btn btn-primary">Start Mode</button>

			<table class="table">
			  <tbody>
				<tr><td>RH x position:</td> <td id="HR_x"></td> </tr>
				<tr><td>RH y position:</td> <td id="HR_y"></td> </tr> 
				<tr><td>RH z position:</td> <td id="HR_z"></td> </tr> 
				<tr><td>LH x position:</td> <td id="HL_x"></td> </tr>
				<tr><td>LH y position:</td> <td id="HL_y"></td> </tr> 
				<tr><td>LH z position:</td> <td id="HL_z"></td> </tr> 
				<tr><td>bendQuanto:</td> 	<td id="bendQuanto"></td> </tr> 
				<tr><td>GestureDirection:</td> <td id="GestureDirection"></td> </tr> 
				<tr><td>RightX:</td> <td id="RightX"></td> </tr> 
<!--				<tr><td>RightXVel:</td> <td id="RightXVel"></td> </tr>   -->
			  </tbody>
			</table>


        <button type="button" id="stop-button"  class="btn btn-danger">Disconnect</button>
	  </div>
	</div>
    </div>
  </div>
</div>
		

		<style>
		#world {
			min-height: 540px;
		}
		.table {
			margin-top: 50px;
		}
		</style>
				

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

		<script src="three.js"></script>
		<script src="OrbitControls.js"></script>
		<script type="text/javascript" src="Pizzicato.js"></script>
		<script type="text/javascript" src="kinectAvatar.js"></script>
		<script type="text/javascript" src="world.js"></script>
		<script type="text/javascript" src="Tone.js"></script>
		<script type="text/javascript" src="THREE.MeshLine.js"></script>
		<script type="text/javascript" src="pitchVolumeOrgan.js"></script>
		<script type="text/javascript" src="airGuitar.js"></script>
		<script type="text/javascript" src="airCello.js"></script>
		<script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>
		<script src='https://surikov.github.io/webaudiofontdata/sound/0300_LesPaul_sf2.js'></script>
		<script src='https://surikov.github.io/webaudiofontdata/sound/0130_FluidR3_GM_sf2_file.js'></script>
		<script src='https://surikov.github.io/webaudiofontdata/sound/0430_SBLive_sf2.js'></script>
		<script>

window.onload = function () {
  	var buttonStop = document.getElementById("stop-button");	
    var label = document.getElementById("status-label");
	var status = document.getElementById("status");
	var running = 0;


	 var world = new interactionWorld(document.getElementById("world"));
	 world.init();
	 var avatar = new kinectAvatar(world,1,false);
	 avatar.addToScene(world.scene);
	 var pitchVolumeOrgan = new PitchVolumeOrgan(); 
	 var airCello = new AirCello(world, avatar); 
	 var airGuitar = new AirGuitar(world, avatar); 


	if (!window.WebSocket) {
        status.innerHTML = "Your browser does not support web sockets!";
        status.classList.add("text-danger");
        return;
    }

    status.innerHTML = "Connecting to server...";
	    var socket = new WebSocket("ws://localhost:8181");

    /* modes:
	0: idle
	1: air guitar
	2: cello
	3: double instrument
    */

    var mode = 0;
  	var buttonSwitchMode = $("#start-button");	

    buttonSwitchMode.click(function(){
    	if (mode > 0) {
    		buttonSwitchMode.addClass("btn-primary");
    		buttonSwitchMode.removeClass("btn-warning");
    		buttonSwitchMode.html("Start");
    		mode = 0;
    	}
    	else {
    		buttonSwitchMode.addClass("btn-warning");
    		buttonSwitchMode.removeClass("btn-primary");
    		buttonSwitchMode.html("Stop");
	    	mode = parseInt($("#mode").val());    		
    	}

    	if (mode == 1) {
    		airGuitar.add_to_world();
    	}
    	else {
    		airGuitar.remove_from_world();
    	}

    	if (mode == 2) {
    		airCello.add_to_world();
    	}
    	else {
    		airCello.remove_from_world();
    	}

    });

    socket.onmessage = function (event) {				
        if (typeof event.data === "string") {
			// Create a JSON object.
            var jsonObject = JSON.parse(event.data);

			if (jsonObject.gesture) {
				if (jsonObject.gesture == "start") {
					running = 1;
					console.log("Starting");
				}
			}

            if (jsonObject.skeletons) {
				if (rightHandY > headY + 0.2) {
		            var data = jsonObject.skeletons[0];
					var rightHandY = data.joints[11].y;
					var headY = data.joints[3].y;

					running = 0;
					console.log("Stopping");
				}
			}

            if (jsonObject.skeletons) {
	            avatar.refresh(jsonObject.skeletons[0]);


				// refresh html elements
	             for (var i = 0; i < jsonObject.skeletons.length; i++) {	
						for (var j = 0; j < jsonObject.skeletons[i].joints.length; j++) {
						var joint = jsonObject.skeletons[i].joints[j];
							
						if (joint.name == "HandRight") {
							var HL_x = joint.x;
							document.getElementById("HR_x").innerHTML = HL_x.toPrecision(4);
							var HL_y = joint.y;
							document.getElementById("HR_y").innerHTML = HL_y.toPrecision(4);
							var HL_z = joint.z;
							document.getElementById("HR_z").innerHTML = HL_z.toPrecision(4);
						}
						else if (joint.name == "HandLeft") {
							var HL_x = joint.x;
							document.getElementById("HL_x").innerHTML = HL_x.toPrecision(4);
							var HL_y = joint.y;
							document.getElementById("HL_y").innerHTML = HL_y.toPrecision(4);
							var HL_z = joint.z;
							document.getElementById("HL_z").innerHTML = HL_z.toPrecision(4);

						}										
	                }
	            }

	            // play sound

	            if (running || true) {
					if (mode == 1) { 
						airGuitar.refresh(jsonObject.skeletons[0]);
					}
					if (mode == 2) { 
						airCello.refresh(jsonObject.skeletons[0]);
					}
					else if (mode == 3) {
		            	pitchVolumeOrgan.refresh(jsonObject.skeletons[0]);					
					}	            	
	            }

	        }    
        }
    }


    socket.onclose = function (event) {
		console.log("Connection closed.");
		
        var code = event.code;
        var reason = event.reason;
        var wasClean = event.wasClean;		
		
        if (wasClean) {
            status.innerHTML = "Connection closed normally.";
        }
        else {
            status.innerHTML = "Connection closed with message: " + reason + " (Code: " + code + ")";
        }
    }

    socket.onerror = function (event) {
        status.innerHTML = "Error: " + event;
    }

    buttonStop.onclick = function (event) {
        if (socket.readyState == WebSocket.OPEN) {
            socket.close();
        }
    }

    socket.onopen = function () {
        status.innerHTML = "Connection successful.";
        status.classList.add("text-success");
		console.log("Connection successful.");
    };
	
}
		</script>

    </body>
</html>



